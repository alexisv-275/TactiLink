<!DOCTYPE html>
<html class="dark" lang="es"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>TactiLink</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-dark": "#1c2127",
                        "surface-light": "#ffffff",
                        "border-dark": "#3b4754",
                        "border-light": "#e5e7eb",
                        "text-secondary-dark": "#9dabb9",
                        "text-secondary-light": "#64748b",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: transparent;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #3b4754;
            border-radius: 20px;
        }
        .braille-pattern {
            background-image: radial-gradient(#3b4754 1px, transparent 1px);
            background-size: 10px 10px;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-white transition-colors duration-200">
<div class="relative flex min-h-screen flex-col overflow-x-hidden">
<header class="sticky top-0 z-10 flex items-center justify-between border-b border-border-light dark:border-[#283039] bg-background-light/80 dark:bg-[#111418]/90 backdrop-blur-md px-6 py-3 lg:px-10">
<div class="flex items-center gap-4">
<div class="flex size-8 items-center justify-center rounded-lg bg-primary/10 text-primary">
<span class="material-symbols-outlined" style="font-size: 24px;">grid_on</span>
</div>
<h1 class="text-lg font-bold leading-tight tracking-tight">TactiLink</h1>
</div>
</header>
<main class="flex-1 px-4 py-8 md:px-8 lg:px-40">
<div class="mx-auto flex max-w-[1024px] flex-col gap-8">
<div class="flex flex-col gap-2">
<h2 class="text-3xl font-bold tracking-tight md:text-4xl">TactiLink</h2>
<p class="text-text-secondary-light dark:text-text-secondary-dark text-base max-w-2xl">
                        Herramienta profesional para la transcripción bidireccional entre códigos Braille y Español. Incluye generación de SVGs y guías de impresión en espejo.
                    </p>
</div>
<div class="rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark shadow-sm">
<div class="grid grid-cols-1 gap-0 lg:grid-cols-[1fr,auto,1fr]">
<div class="flex flex-col p-6">
<label class="mb-3 flex items-center gap-2 text-sm font-semibold text-primary" for="braille-input">
<span class="material-symbols-outlined text-[18px]">pin</span>
                                Código Numérico Braille
                            </label>
<textarea class="w-full flex-1 resize-none rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-[#111418] p-4 text-base font-mono focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary min-h-[200px]" id="braille-input" placeholder="Ej: 1-3-4-5 (Ingrese códigos numéricos)"></textarea>
<p class="mt-2 text-xs text-text-secondary-light dark:text-text-secondary-dark">
                                Use guiones para separar puntos (1-6) y espacios para separar celdas.
                            </p>
</div>
<div class="flex items-center justify-center gap-2 border-y border-border-light dark:border-border-dark bg-slate-50 dark:bg-[#161b22] px-4 py-4 lg:flex-col lg:border-x lg:border-y-0 lg:py-0">
<button id="btn-to-spanish" class="group flex size-10 items-center justify-center rounded-full bg-primary text-white shadow-md hover:bg-blue-600 transition-transform active:scale-95" title="Traducir a Español">
<span class="material-symbols-outlined lg:hidden">arrow_downward</span>
<span class="material-symbols-outlined hidden lg:block">arrow_forward</span>
</button>
<button id="btn-to-braille" class="group flex size-10 items-center justify-center rounded-full bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark text-slate-700 dark:text-white shadow-sm hover:bg-slate-50 dark:hover:bg-[#283039] transition-transform active:scale-95" title="Traducir a Braille">
<span class="material-symbols-outlined lg:hidden">arrow_upward</span>
<span class="material-symbols-outlined hidden lg:block">arrow_back</span>
</button>
<button id="btn-clear" class="group flex size-10 items-center justify-center rounded-full bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark text-slate-500 hover:text-red-600 dark:text-slate-400 dark:hover:text-red-400 shadow-sm hover:bg-slate-50 dark:hover:bg-[#283039] transition-transform active:scale-95" title="Limpiar todo">
<span class="material-symbols-outlined">delete</span>
</button>
</div>
<div class="flex flex-col p-6">
<label class="mb-3 flex items-center gap-2 text-sm font-semibold text-primary" for="spanish-input">
<span class="material-symbols-outlined text-[18px]">translate</span>
                                Texto en Español
                            </label>
<textarea class="w-full flex-1 resize-none rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-[#111418] p-4 text-base focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary min-h-[200px]" id="spanish-input" placeholder="Escriba el texto para traducir..."></textarea>
<p class="mt-2 text-xs text-text-secondary-light dark:text-text-secondary-dark">
                                Soporta caracteres especiales y acentos.
                            </p>
</div>
</div>
<div class="flex flex-col gap-8 border-t border-border-light dark:border-border-dark bg-slate-50/50 dark:bg-[#161b22]/50 p-6">
<div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
<div class="flex-1">
<h3 class="mb-2 text-sm font-bold text-slate-900 dark:text-white">Vista Previa Visual</h3>
<div id="visual-preview" class="flex min-h-[80px] w-full items-center overflow-x-auto rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] p-4 braille-pattern">
<div class="flex gap-3">
<div class="grid grid-cols-2 gap-1 w-6 h-10">
<div class="size-2 rounded-full bg-slate-900 dark:bg-white"></div><div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
<div class="size-2 rounded-full bg-slate-900 dark:bg-white"></div><div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
<div class="size-2 rounded-full bg-slate-900 dark:bg-white"></div><div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
</div>
<div class="grid grid-cols-2 gap-1 w-6 h-10">
<div class="size-2 rounded-full bg-slate-900 dark:bg-white"></div><div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
<div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div><div class="size-2 rounded-full bg-slate-900 dark:bg-white"></div>
<div class="size-2 rounded-full bg-slate-900 dark:bg-white"></div><div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
</div>
<div class="grid grid-cols-2 gap-1 w-6 h-10">
<div class="size-2 rounded-full bg-slate-900 dark:bg-white"></div><div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
<div class="size-2 rounded-full bg-slate-900 dark:bg-white"></div><div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
<div class="size-2 rounded-full bg-slate-900 dark:bg-white"></div><div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
</div>
<div class="grid grid-cols-2 gap-1 w-6 h-10">
<div class="size-2 rounded-full bg-slate-900 dark:bg-white"></div><div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
<div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div><div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
<div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div><div class="size-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
</div>
</div>
</div>
</div>
<div class="flex flex-shrink-0 flex-col gap-3 pt-6 sm:pt-0">
<button id="btn-download-svg" class="flex items-center justify-center gap-2 rounded-lg bg-primary px-6 py-2.5 text-sm font-bold text-white shadow hover:bg-blue-600 transition-colors">
<span class="material-symbols-outlined">download</span>
                                    Descargar SVG
                                </button>
<button id="btn-download-png" class="flex items-center justify-center gap-2 rounded-lg bg-white dark:bg-[#283039] border border-border-light dark:border-border-dark px-6 py-2.5 text-sm font-bold text-slate-700 dark:text-white hover:bg-slate-50 transition-colors">
<span class="material-symbols-outlined">image</span>
                                    Guardar PNG
                                </button>
</div>
</div>
<div class="h-px w-full bg-border-light dark:bg-border-dark opacity-50"></div>
<div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
<div class="flex-1">
<h3 class="mb-2 flex items-center gap-2 text-sm font-bold text-slate-900 dark:text-white">
<span class="material-symbols-outlined text-primary text-[18px]">flip</span>
                                    Resultado (Espejo)
                                </h3>
<div id="espejo-preview" class="flex min-h-[80px] w-full items-center justify-end overflow-x-auto rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] p-4 braille-pattern">
<div class="text-4xl font-bold tracking-widest text-primary opacity-90" style="transform: scaleX(-1);">
                                        ⠓⠕⠇⠁
                                    </div>
</div>
</div>
<div class="flex flex-shrink-0 flex-col gap-3 pt-6 sm:pt-0 sm:items-center sm:self-center">
<button id="btn-generate-espejo" class="flex w-full sm:w-auto items-center justify-center gap-2 rounded-lg bg-primary px-6 py-2.5 text-sm font-bold text-white shadow hover:bg-blue-600 transition-colors">
<span class="material-symbols-outlined">sync_alt</span>
                                    Generar Espejo
                                </button>
</div>
</div>
</div>
</div>
</div>
</main>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // ========== ELEMENTOS DEL DOM ==========
    const brailleInput = document.getElementById('braille-input');
    const spanishInput = document.getElementById('spanish-input');
    const btnToSpanish = document.getElementById('btn-to-spanish');
    const btnToBraille = document.getElementById('btn-to-braille');
    const btnClear = document.getElementById('btn-clear');
    const btnDownloadSVG = document.getElementById('btn-download-svg');
    const btnDownloadPNG = document.getElementById('btn-download-png');
    const btnGenerateEspejo = document.getElementById('btn-generate-espejo');
    const visualPreview = document.getElementById('visual-preview');
    const espejoPreview = document.getElementById('espejo-preview');

    // Variables globales para almacenar SVGs
    let currentSvgNormal = null;
    let currentSvgEspejo = null;

    // ========== FUNCIONES AUXILIARES ==========

    /**
     * Función genérica para hacer peticiones POST a la API
     * @param {string} endpoint - Ruta del endpoint (ej: '/api/transcribe')
     * @param {object} data - Datos a enviar en el body
     * @returns {Promise<Response|null>} - Respuesta del fetch o null si hay error
     */
    const fetchAPI = async (endpoint, data) => {
      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }

        return response;
      } catch (error) {
        console.error(`Error al comunicarse con ${endpoint}:`, error);
        alert(`ERROR: No se pudo conectar con el servicio. Verifica que Docker esté ejecutándose.`);
        return null;
      }
    };

    /**
     * Descarga un archivo desde contenido de texto
     * @param {string} content - Contenido del archivo
     * @param {string} filename - Nombre del archivo a descargar
     * @param {string} mimeType - Tipo MIME del archivo
     */
    const downloadFile = (content, filename, mimeType) => {
      try {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
      } catch (error) {
        console.error('Error al descargar archivo:', error);
        alert('Error al descargar el archivo.');
      }
    };

    /**
     * Limpia el nombre de archivo removiendo caracteres no permitidos
     * @param {string} text - Texto a limpiar
     * @returns {string} - Texto limpio para nombre de archivo
     */
    const cleanFilename = (text) => {
      return text.replace(/[^a-zA-Z0-9áéíóúñü]/g, '_').substring(0, 50);
    };

    /**
     * Muestra un mensaje de placeholder en un contenedor
     * @param {HTMLElement} container - Contenedor donde mostrar el mensaje
     * @param {string} message - Mensaje a mostrar
     */
    const showPlaceholder = (container, message) => {
      container.innerHTML = `<p class="text-text-secondary-light dark:text-text-secondary-dark text-sm">${message}</p>`;
    };

    // ========== A1: TRANSCRIPCIÓN TEXTO → BRAILLE ==========

    /**
     * Transcribe texto español a código Braille numérico
     */
    const transcribeTextToBraille = async () => {
      const text = spanishInput.value.trim();
      
      if (!text) {
        alert('Por favor, ingresa texto en español para transcribir.');
        return;
      }

      // Mostrar estado de carga
      brailleInput.value = 'Transcribiendo...';
      showPlaceholder(visualPreview, 'Generando vista previa...');

      const response = await fetchAPI('/api/transcribe', { text });
      
      if (!response) {
        brailleInput.value = '';
        showPlaceholder(visualPreview, 'Error al transcribir.');
        return;
      }

      const data = await response.json();
      
      if (data.error) {
        brailleInput.value = '';
        alert(`Error de API: ${data.error}`);
        showPlaceholder(visualPreview, 'Error en la transcripción.');
      } else {
        // Mostrar códigos Braille en el textarea
        brailleInput.value = data.braille_codes || 'No se pudo generar código.';
        
        // Generar SVG automáticamente para vista previa
        await generateSVGPreview(text);
      }
    };

    /**
     * Genera el SVG y lo muestra en la vista previa (sin descargar)
     * @param {string} text - Texto para generar el SVG
     */
    const generateSVGPreview = async (text) => {
      showPlaceholder(visualPreview, 'Generando SVG...');

      const response = await fetchAPI('/api/generar_senaletica', { text });
      
      if (!response) {
        showPlaceholder(visualPreview, 'Error al generar SVG.');
        return;
      }

      // El endpoint devuelve SVG como texto, no JSON
      const svgText = await response.text();
      
      // Guardar SVG para uso posterior
      currentSvgNormal = svgText;

      // Mostrar SVG en la vista previa
      visualPreview.innerHTML = svgText;
    };

    // ========== A2: DESCARGA DE SVG NORMAL ==========

    /**
     * Descarga el SVG de la señalética normal
     * Si ya existe un SVG generado, lo descarga directamente
     * Si no, genera uno nuevo
     */
    const downloadSVGNormal = async () => {
      const text = spanishInput.value.trim();
      
      if (!text) {
        alert('Por favor, ingresa texto en español para generar el SVG.');
        return;
      }

      // Si no hay SVG generado, generarlo primero
      if (!currentSvgNormal) {
        await generateSVGPreview(text);
      }

      // Si después de intentar generar sigue sin SVG, salir
      if (!currentSvgNormal) {
        alert('No se pudo generar el SVG.');
        return;
      }

      // Descargar el SVG
      const filename = `senaletica_braille_${cleanFilename(text)}.svg`;
      downloadFile(currentSvgNormal, filename, 'image/svg+xml;charset=utf-8');
    };

    // ========== C1: LIMPIAR TODO ==========

    /**
     * Limpia todos los campos y vistas previas
     */
    const clearAll = () => {
      brailleInput.value = '';
      spanishInput.value = '';
      currentSvgNormal = null;
      currentSvgEspejo = null;
      
      // Restaurar placeholders
      showPlaceholder(visualPreview, 'Vista previa de Braille aparecerá aquí.');
      showPlaceholder(espejoPreview, 'Vista espejo aparecerá aquí.');
    };

    // ========== FUNCIÓN AUXILIAR: VISTA PREVIA ==========

    /**
     * Actualiza la vista previa visual de Braille (placeholder por ahora)
     * @param {string} brailleCodes - Códigos Braille separados por espacios
     */
    const updateVisualPreview = (brailleCodes) => {
      // Por ahora, solo mostrar un mensaje
      // La implementación completa de círculos Braille se hará después
      if (brailleCodes) {
        showPlaceholder(visualPreview, `Códigos Braille: ${brailleCodes.split(' ').length} celdas`);
      } else {
        showPlaceholder(visualPreview, 'Vista previa de Braille aparecerá aquí.');
      }
    };

    // ========== EVENT LISTENERS ==========

    btnToBraille.addEventListener('click', transcribeTextToBraille);
    btnDownloadSVG.addEventListener('click', downloadSVGNormal);
    btnClear.addEventListener('click', clearAll);

    // Placeholders iniciales
    showPlaceholder(visualPreview, 'Vista previa de Braille aparecerá aquí.');
    showPlaceholder(espejoPreview, 'Vista espejo aparecerá aquí.');

    // Deshabilitar botón PNG temporalmente (no implementado)
    btnDownloadPNG.disabled = true;
    btnDownloadPNG.style.opacity = '0.5';
    btnDownloadPNG.style.cursor = 'not-allowed';
    btnDownloadPNG.title = 'Función no disponible';

    console.log('✅ TactiLink cargado correctamente');
  });
</script>
</body></html>